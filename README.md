# envers-validation-maven-plugin
This is a maven plugin which validates the structure and content of audit revisions generated/managed by hibernate-envers.

This plugin is especially useful for databases where the table structure or content is not always generated by Envers.
I.e. in databases where DBA sometimes runs a custom scrip to fix high priority issues or where release scripts are generated by another framework.

## What the plugin does
The plugin connects with your database and will inform you of the following:
- Any unknown audit or content table
    - If one or more audit tables specified in the whitelist are not present in the database.
    - If a table exists with a name that ends in _AUD but the table name is not present in the whitelist, assuming that only audit tables end in _AUD.
    - If a table was found with a foreign key to the revinfo table but the table name is not present in the whitelist.
    - If an audit table exists but the content table does not.
- Incorrect structure of the audit table
    - A primary key for an audit table which does not match with the primary key of the content table. (Primary key of an audit table should consist of the primary key columns of the content table + the rev column.)
    - An audit table does not have a foreign key to the revinfo table.
    - If a column in the audit table is nonnull but the column is not part of the primary key, as this prevents Envers from inserting 'Remove' revisions.
- Incorrect revisions, for example:
    - If the history of a specific record is invalid. For example: Starting with an 'Modify' or 'Remove' revision, as these can only exist after an 'Add' revision and indicates missing revisions.
    - If the content has a column 'ENABLED' and the value of this column = 'true', but the latest revision has a value of 'false' then a validation error will be thrown.
    - The content no longer exists in the content table, but the latest revision for the primary key is 'Add' or 'Modify' instead of 'Remove'.
    - The latest revision is 'Remove' but there is still a record in the content table.  

## How to use the plugin
### Pom.xml
```
<plugin>
    <groupId>com.github.zeger-tak</groupId>
    <artifactId>envers-validation-maven-plugin</artifactId>
    <version>${envers-validation-version}</version>
    <configuration>
        <connectionPropertyFile>src/test/resources/connection.properties</connectionPropertyFile>
        <!--Add the following to ignore specific validations-->
        <ignorables>
            <ignorable>RevisionValidator</ignorable> <!--To ignore the entire validator. -->
            <ignorable>RevisionValidator.validateAllRecordsInAuditedTableHaveAValidLatestRevision</ignorable> <!--To ignore a specific validation method.-->
            <ignorable>RevisionValidator.validateAllRecordsInAuditedTableHaveAValidLatestRevision.CONTENT_TABLE_NAME</ignorable> <!--To ignore a specific run of a validation method.-->
        </ignorables>
    </configuration>
    <dependencies>
        <!-- Add this dependency when running against an oracle db, -->
        <dependency>
            <groupId>com.oracle</groupId>
            <artifactId>ojdbc6</artifactId>
            <version>11.2.0.4</version>
        </dependency>
        <!-- Add this dependency when running against a postgreql db, -->
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <version>9.3-1102-jdbc41</version>
        </dependency>
    </dependencies>
</plugin>
```
### Connection property file
The following properties should be provided within the connection property file:
```
url=jdbc:postgresql://localhost/schemaname #example of a jdbc connection url.
driver=org.postgresql.Driver #example of the driver class.
username=dbuser
password=dbpassword

whiteListPropertyFile=src/test/resources/known_audit_tables.properties #relative path to the whitelist property file.
```

### Whitelist property file
The whitelist property file is a regular property file.
On each line the property key is filled with the name of the audit table and the property value is filled with the name of the table holding the current content.
The property value will be automatically resolved if it is not provided by taking the audit table name and removing the default appendix of _aud.
So for a database with 3 audit tables and 3 content tables the file might look like the following:
```
TABLE_NAME_1_AUD=  #the resolved content table name will be TABLE_NAME_1
TABLE_NAME_2_AUDIT=NAME_TABLE_2 #here the content table name is provided because the name cannot be automatically resolved by removing the appendix.
TABLE_NAME_3_AUD=TABLE_NAME_3 #here the content table name is provided even though the content table name could have been resolved automatically. 
```

### Executing the plugin
The plugin can now be executed with the following statement
``` envers-validation:validate ```

Or added to a phase and automatically executed during this phase by adding the following lines to the pom.xml
```
<executions>
    <execution>
        <phase>verify</phase>
        <goals>
            <goal>validate</goal>
        </goals>
    </execution>
</executions>
```